<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd">

     <!--version without the ctas, we read directly from the table -->
    <bean id="psmClusterReader" scope="step"
          class="org.springframework.batch.item.database.JdbcCursorItemReader">
        <property name="dataSource" ref="clusterDataSource"/>
        <property name="sql">
            <value>
                SELECT
                    UNIQUE
                    PSM.SEQUENCE SEQUENCE,
                    PSM.MODIFICATIONS MODS,
                    ASSAY.TAXID TAXID,
                    ASSAY.ASSAY_ACCESSION ASSAY_ACCESSION,
                    ASSAY.PROJECT_ACCESSION PROJECT_ACCESSION,
                    SPECTRUM_CLUSTER.CLUSTER_PK CLUSTER_ID
                FROM
                    (SELECT
                        CLUSTER_PK
                    FROM
                        PRIDECLUS.SPECTRUM_CLUSTER
                    WHERE SPECTRUM_CLUSTER.QUALITY = 1) SPECTRUM_CLUSTER,
                    (SELECT
                        RANK,
                        CLUSTER_FK,
                        PSM_FK
                    FROM
                        PRIDECLUS.CLUSTER_HAS_PSM
                    WHERE
                        CLUSTER_HAS_PSM.RANK = 1.1) CLUSTER_HAS_PSM,
                    PRIDECLUS.PSM PSM,
                    (SELECT
                        ASSAY.ASSAY_PK,
                        ASSAY.TAXONOMY_ID TAXID,
                        ASSAY.ASSAY_ACCESSION ASSAY_ACCESSION,
                        ASSAY.PROJECT_ACCESSION PROJECT_ACCESSION
                    FROM
                        PRIDECLUS.ASSAY
                    WHERE
                        ASSAY.MULTI_SPECIES = 0 AND ASSAY.TAXONOMY_ID IN ('9606','10090','3702','10116')) ASSAY
                WHERE
                    SPECTRUM_CLUSTER.CLUSTER_PK = CLUSTER_HAS_PSM.CLUSTER_FK
                    AND CLUSTER_HAS_PSM.PSM_FK  = PSM.PSM_PK
                    AND PSM.ASSAY_FK            = ASSAY.ASSAY_PK
            </value>
        </property>
        <property name="rowMapper">
            <bean class="uk.ac.ebi.pride.proteomes.pipeline.provider.generator.mapper.PsmsClusterRowMapper"/>
        </property>
        <property name="fetchSize" value="10000"/>
    </bean>

    <bean id="psmClusterItemProcessor" scope="step"
          class="org.springframework.batch.item.support.CompositeItemProcessor">
        <property name="delegates">
            <list>
                <ref bean="psmModMapper"/>
                <ref bean="psmValidator"/>
            </list>
        </property>
    </bean>

    <bean id="psmClusterWriter" class="org.springframework.batch.item.support.CompositeItemWriter" >
        <property name="delegates">
            <list>
                <ref bean="delegatePsmClusterWriter"/>
            </list>
        </property>
    </bean>

    <bean id="psmModMapper" class="uk.ac.ebi.pride.proteomes.pipeline.provider.generator.filter.ClusterPsmItemMapMods"/>

    <bean id="psmValidator" class="org.springframework.batch.item.validator.ValidatingItemProcessor">
        <property name="filter" value="false"/>
        <property name="validator" ref="defaultValidator"/>
    </bean>

    <bean id="delegatePsmClusterWriter" class="org.springframework.batch.item.database.JpaItemWriter" >
        <property name="entityManagerFactory" ref="proteomesEntityManagerFactory"/>
    </bean>

    <!-- Uncomment for writing in a file-->
    <!--<bean id="delegatePsmClusterWriter" scope="step" class="org.springframework.batch.item.file.FlatFileItemWriter">-->
         <!--&lt;!&ndash;write to this csv file &ndash;&gt;-->
        <!--<property name="resource" value="file:ouput/psm-cluster.csv"/>-->
        <!--<property name="shouldDeleteIfExists" value="true"/>-->

        <!--<property name="lineAggregator">-->
            <!--<bean-->
                    <!--class="org.springframework.batch.item.file.transform.DelimitedLineAggregator">-->
                <!--<property name="delimiter">-->
                    <!--<util:constant-->
                            <!--static-field="org.springframework.batch.item.file.transform.DelimitedLineTokenizer.DELIMITER_TAB"/>-->
                <!--</property>-->
                <!--<property name="fieldExtractor">-->
                    <!--<bean class="org.springframework.batch.item.file.transform.BeanWrapperFieldExtractor">-->
                        <!--<property name="names" value="psmId,sequence,taxid,modifications,assayAccession,projectAccession,clusterId"/>-->
                    <!--</bean>-->
                <!--</property>-->
            <!--</bean>-->
        <!--</property>-->
    <!--</bean>-->

</beans>
